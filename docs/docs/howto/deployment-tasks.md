---
title: 'Deployment tasks'
description: 'Description of how to use Welder for deployment of services'
platform: platform
product: welder
category: devguide
subcategory: learning
guides: tutorials
date: '2022-08-22'
---

# Deploy services with Welder

Welder supports `welder deploy` command that intends to deploy your service. Your service or application
may understand different things by "deployment", i.e. it could be just publishing a new version of the library to 
the remote repository or upload of some files to Statlas. However, if you are going to deploy to Micros, Welder
can do it for you automatically (see `Micros deployments` section below).

## Generic deployments

Generic deployment steps are pretty much the same as build steps, the difference is that every deployment assumes that 
it should be deployed to a specific "environment". To specify what environments you'd like to deploy your service to
you need to add `environments` section under `deploy` section in the descriptor:

```yaml
# ...
modules:
  - name: myservice
    deploy:
      environments:
        development:
          autoDeploy: true # this is important when generating Bamboo/BBP configuration to allow automatic deployment
        production: {}
      steps:
        - step:
            runOn: host
            script:
              - atlas statlas put --auth-group mygroup --namespace=${project:env} -f ${project:root}/myservice.zip
# ...
```
In the example above we assume that some zip archive is produced after the build step, and it should be uploaded to
[statlas](/platform/statlas/). Depending on which environment is provided to `welder deploy` command, the
`--namespace` argument will be set to `development` or `production`.

!!! note
    `${project:env}` expression gets replaced with the actual value when you invoke a deployment command. For
    `welder deploy -e ddev` it will be replaced with `ddev`.

### Pushed images summary

After pushing Docker images Welder generates some files under `.welder-out` directory. These files are used
by Welder while running deployment steps to supply fully resolved Docker digests and tags of all pushed images. 
They are automatically set by Welder as environment variables supplied to deploy steps. 

At first there is a file called `.welder-out/docker.yaml` used by Welder when it runs deployment steps. 
Primarily this is used when running Micros deployments (see below). 

Another file generated by Welder is called `.welder-out/docker-pushed-images.sh`. It can be used in scripts or
passed to other tools, such as e.g. [spinnaker pipe](/platform/spinnaker/default-pipelines/getting-started/#option-2--bitbucket-pipelines-pipe).
The file contains a list of environment variables that can be used to access pushed images. 

```yaml
# ...
modules:
  - name: myservice
    dockerImages:
      - name: main-image
        dockerFile: ${project:root}/Dockerfile
        tags:
          - docker.simple-container.com/dev/myservice:latest
    deploy:
      steps:
        - task: deploy
# ...
```
Given the example above the contents of this file may look like:

```bash
export MYSERVICE_MAIN_IMAGE_TAG=latest
export MYSERVICE_MAIN_IMAGE_IMAGE=docker.simple-container.com/dev/myservice
export MYSERVICE_MAIN_IMAGE_DIGEST=sha256:1304f174557314a7ed9eddb4eab12fed12cb0cd9809e4c28f29af86979a3c870
export MYSERVICE_MAIN_IMAGE_0_TAG=latest
export MYSERVICE_MAIN_IMAGE_0_IMAGE=docker.simple-container.com/dev/myservice
export MYSERVICE_MAIN_IMAGE_0_DIGEST=sha256:1304f174557314a7ed9eddb4eab12fed12cb0cd9809e4c28f29af86979a3c870
```

You can supply this file to [spinnaker pipe](/platform/spinnaker/default-pipelines/getting-started/#option-2--bitbucket-pipelines-pipe)
to trigger Spinnaker deployment in the following way (part of `bitbucket-pipelines.yml`):

```yaml
# ...
  - pipe: docker://docker.simple-container.com/atlassian/spinnaker-deploy:latest
    variables:
      SERVICE_NAME: myservice
      SERVICE_DESCRIPTOR: ${project:root}/myservice.sd.yml
      BEFORE_SCRIPT: ". .welder-out/docker-pushed-images.sh"
# ...
```

## Micros deployments

In your service descriptor (`myservice.sd.yml`) you can use the following syntax to reference pushed images:

```yaml
# ...
compute:
  type: kubernetes
  attributes:
    containers:
      - name: myservice
        image: ${MYSERVICE_MAIN_IMAGE_IMAGE}@${MYSERVICE_MAIN_IMAGE_DIGEST}
# ...
```

## Running Bitbucket pipes

Welder can run Bitbucket Pipeline Pipes without any additional changes to `bitbucket-pipelines.yml` file. You
can simply reference a pipe by its name:

```yaml
# ...
modules:
  - name: myservice
    dockerImages:
      - name: main-image
        dockerFile: ${project:root}/Dockerfile
        tags:
          - docker.simple-container.com/dev/myservice:latest
    deploy:
      env:
        SERVICE_NAME: myservice
        SERVICE_DESCRIPTOR: ${project:root}/myservice.sd.yml
        BEFORE_SCRIPT: ". ${project:root}/.welder-out/docker-pushed-images.sh"
      steps:
        - pipe: docker://docker.simple-container.com/atlassian/spinnaker-deploy:latest
# ...
```

!!! note
    When pipe is invoked directly from `welder.yaml`, environment variables are set through `env` within `deploy` 
    section in contrast to `bitbucket-pipelines.yml` file where there is an additional `variables` section added to `pipe`.

To allow running `spinnaker-deploy` pipe locally you will need to provide a valid `SLAUTH_OVERRIDE_TOKEN` environment
variable, so that the pipe actually works from your local machine. This can be done using a `local` profile and a task
that generates the token:

```yaml
# ...
profiles:
  local:
    activation:
      if: "!${mode:pipelines} && !${mode:bamboo}"
    build:
      env:
        SLAUTH_OVERRIDE_TOKEN: ${task:slauth-token.trim:-}
# ...
tasks:
  slauth-token:
    runOn: host
    script:
      - atlas slauth token --aud config-registry --aud spinnaker -g micros-sv--myservice-dl-admins -o jwt
```

Make sure you've replaced `myservice` with the correct service name everywhere (including `micros-sv--myservice-dl-admins`).